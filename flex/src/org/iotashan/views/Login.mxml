<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" height="100%" xmlns:mate="http://mate.asfusion.com/">
	<mx:Script>
		<![CDATA[
			import org.iotashan.business.ErrorManager;
			import mx.validators.Validator;
			import com.asfusion.mate.events.ResponseEvent;
			import org.iotashan.events.LoginEvent;
			import org.iotashan.vos.User;
			
			[Bindable] private var tmpUser:User;
			
			private function doValidation():void {
				// validate the form
				var results:Array = Validator.validateAll(validators);
				
				// if any fields were not valid, do nothing
				if (results.length > 0) {
					return;
				}
				
				tmpUser = new User();
				tmpUser.email = inputUsername.text;
				tmpUser.password = inputPassword.text;
				
				// dispatch the event
				loginDispatcher.generateEvent();
			}
			
			private function tryLogin(val:Object):void {
				var resultUser:User = val as User;
				
				if (resultUser.UserID == 0) {
					// login failed
					inputUsername.errorString = "Login Failed. Please try again";
					inputUsername.setFocus();
					
					dispatchEvent(new LoginEvent(LoginEvent.LOGIN_UNSUCCESSFUL));
				} else {
					var myEvent:LoginEvent = new LoginEvent(LoginEvent.LOGIN_SUCCESSFUL);
					myEvent.user = resultUser;
					
					dispatchEvent(myEvent);
				}
			}
		]]>
	</mx:Script>
	
	<!-- event dispatcher -->
	<mate:Dispatcher id="loginDispatcher" generator="{LoginEvent}" type="{LoginEvent.LOGIN}">
		<mate:eventProperties>
			<mate:EventProperties user="{tmpUser}"/>
		</mate:eventProperties>
		
		<mate:ServiceResponseHandler result="tryLogin(event.result)"/>
	</mate:Dispatcher>
	
	<!-- validators -->
	<mx:Array id="validators">
		<mx:EmailValidator id="vEmail" required="true" source="{inputUsername}" property="text"/>
		<mx:StringValidator id="vPassword" required="true" source="{inputPassword}" property="text"/>
	</mx:Array>
	
	<!-- view -->
	<mx:Panel layout="vertical" horizontalCenter="0" verticalCenter="0" title="Log In">
		<mx:Form width="100%" height="100%" defaultButton="{btnLogin}">
			<mx:FormItem label="Username" required="true" labelWidth="70">
				<mx:TextInput id="inputUsername"/>
			</mx:FormItem>
			<mx:FormItem label="Password" required="true" labelWidth="70">
				<mx:TextInput displayAsPassword="true" id="inputPassword"/>
			</mx:FormItem>
			<mx:HBox width="100%" verticalAlign="middle">
				<mx:Spacer width="76" height="10"/>
				<mx:Button label="Log In" id="btnLogin" click="doValidation()"/>
				<mx:Text text="or"/>
<!--
				<mx:LinkButton label="Create an Account" click="doCreateAccount()"/>
-->
			</mx:HBox>
		</mx:Form>
	</mx:Panel>
</mx:Canvas>
