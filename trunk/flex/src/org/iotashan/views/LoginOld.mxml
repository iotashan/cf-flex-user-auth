<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" height="100%">
	<mx:RemoteObject id="dataService" destination="ColdFusion" source="model.UserGateway" showBusyCursor="true">
		<mx:method name="tryLogin" result="tryLoginResult(event)" fault="ErrorManager.remoteError(event)"/>
	</mx:RemoteObject>

    <mx:Metadata>
        [Event(name="onCreateAccount", type="flash.events.Event")]
        [Event(name="onLogin", type="flash.events.Event")]
    </mx:Metadata>

	<mx:Script>
		<![CDATA[
			import mx.rpc.events.ResultEvent;
			import org.iotashan.model.User;
			import org.iotashan.control.ErrorManager;
			import mx.events.ValidationResultEvent;
			
			private function doCreateAccount():void {
				dispatchEvent(new Event("onCreateAccount",true));
			}
			
			private function doValidation():void {
				var vResult:ValidationResultEvent;
				
				vResult = vEmail.validate();
				if (vResult.type==ValidationResultEvent.INVALID) {
					inputUsername.setFocus();
					return;
				}
				
				vResult = vPassword.validate();
				if (vResult.type==ValidationResultEvent.INVALID) {
					inputPassword.setFocus();
					return;
				}
				
				// if al validation passed, submit
				doLogin();
			}
			
			private function doLogin():void {
				var loginUser:User = new User();
				
				loginUser.email = inputUsername.text;
				loginUser.password = inputPassword.text;
				
				dataService.tryLogin(loginUser);
			}
			
			private function tryLoginResult(e:ResultEvent):void {
				var resultUser:User = e.result as User;
				
				if (resultUser.UserID == 0) {
					// login failed
					inputUsername.errorString = "Login Failed. Please try again";
					inputUsername.setFocus();
				} else {
					dispatchEvent(new Event("onLogin",true));
				}
			}
		]]>
	</mx:Script>
	
	<mx:EmailValidator id="vEmail" required="true" source="{inputUsername}" property="text"/>
	<mx:StringValidator id="vPassword" required="true" source="{inputPassword}" property="text"/>
	
	<mx:Panel layout="vertical" horizontalCenter="0" verticalCenter="0" title="Log In">
		<mx:Form width="100%" height="100%" defaultButton="{btnLogin}">
			<mx:FormItem label="Username" required="true" labelWidth="70">
				<mx:TextInput id="inputUsername"/>
			</mx:FormItem>
			<mx:FormItem label="Password" required="true" labelWidth="70">
				<mx:TextInput displayAsPassword="true" id="inputPassword"/>
			</mx:FormItem>
			<mx:HBox width="100%" verticalAlign="middle">
				<mx:Spacer width="76" height="10"/>
				<mx:Button label="Log In" id="btnLogin" click="doValidation()"/>
				<mx:Text text="or"/>
				<mx:LinkButton label="Create an Account" click="doCreateAccount()"/>
			</mx:HBox>
		</mx:Form>
	</mx:Panel>
	
</mx:Canvas>
